<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
Â  Â  <title>Donut Miner ãƒ„</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  /* KISSAKI/TAMAGOTCHI AESTHETIC STYLINGÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  /* =============================================================== */

Â  Â  Â  Â  /* Custom Font - Nunito is a good match for the cute, rounded look */
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap'); /* Changed to Comic Neue */
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap'); /* NEW: Added Luckiest Guy font */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* This is the "browser" background, outside the phone */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
Â  Â  Â  Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  Â  Â  Â  Â  overscroll-behavior: none; /* Prevents "pull-to-refresh" */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Apply app-shell styling directly to body */
Â  Â  Â  Â  Â  Â  background-color: #FFC0CB; /* Soft Pink */
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.7'%3E%3Crect x='10' y='10' width='3' height='10' fill='%23FFD700' transform='rotate(25 11.5 15)' /%3E%3Crect x='60' y='30' width='3' height='10' fill='%23FF69B4' transform='rotate(140 61.5 35)' /%3E%3Crect x='30' y='70' width='3' height='10' fill='%2390EE90' transform='rotate(70 31.5 75)' /%3E%3Crect x='80' y='85' width='3' height='10' fill='%2387CEEB' transform='rotate(210 81.5 90)' /%3E%3Crect x='5' y='45' width='3' height='10' fill='%23FFD700' transform='rotate(100 6.5 50)' /%3E%3Crect x='90' y='5' width='3' height='10' fill='%23FF69B4' transform='rotate(300 91.5 10)' /%3E%3C/g%3E%3C/svg%3E"),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(135deg, #FFC0CB 0%, #FFDDE1 100%); /* Soft Pink base */
Â  Â  Â  Â  Â  Â  background-size: 200px 200px, cover; /* Adjust size for sprinkles, cover for gradient */
Â  Â  Â  Â  Â  Â  background-blend-mode: overlay, normal;
Â  Â  Â  Â  Â  Â  background-attachment: fixed;
Â  Â  Â  Â  Â  Â  color: #333333; /* Dark gray for general text */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Ensure the body takes full viewport height and manages overflow */
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex; /* Use flexbox to organize main content and nav */
Â  Â  Â  Â  Â  Â  flex-direction: column; /* Stack content vertically */
Â  Â  Â  Â  Â  Â  padding: 0; /* Remove padding */
Â  Â  Â  Â  Â  Â  margin: 0; /* Remove margin */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Custom Colors inspired by Tamagotchi */
Â  Â  Â  Â  /* Changed to pale butter yellow */
Â  Â  Â  Â  .bg-tamagotchi-bg-light { background-color: #FFFACD; }Â 
Â  Â  Â  Â  .text-tamagotchi-dark { color: #333333; } /* General dark text */
Â  Â  Â  Â  .text-tamagotchi-pink-dark { color: #E75480; } /* Stronger, cuter pink for accents/headings */
Â  Â  Â  Â  .text-tamagotchi-pink-light { color: #FF9AA2; } /* Lighter pink for accents */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Button colors */
Â  Â  Â  Â  .bg-tamagotchi-button-pink {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(to bottom, #FFDDE1, #E75480); /* Puffy pink gradient */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  Â  Â  border: 2px solid #C04A70; /* Darker border for depth */
Â  Â  Â  Â  }
Â  Â  Â  Â  .bg-tamagotchi-button-teal {Â 
Â  Â  Â  Â  Â  Â  background: linear-gradient(to bottom, #B3F0E6, #66CCBF); /* Teal gradient */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  Â  Â  border: 2px solid #50A89C; /* Darker border for depth */
Â  Â  Â  Â  }
Â  Â  Â  Â  .bg-tamagotchi-button-pink:active, .bg-tamagotchi-button-teal:active {
Â  Â  Â  Â  Â  Â  transform: translateY(1px); /* Simple press effect */
Â  Â  Â  Â  Â  Â  box-shadow: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Border/Card colors */
Â  Â  Â  Â  .border-tamagotchi-subtle { border-color: #E0E0E0; } /* Light gray border */
Â  Â  Â  Â  /* Changed to pale butter yellow */
Â  Â  Â  Â  .bg-tamagotchi-card {Â 
Â  Â  Â  Â  Â  Â  background-color: #FFFACD; /* Pale Butter Yellow for cards */
Â  Â  Â  Â  Â  Â  border: 2px solid #E0E0E0; /* Subtle border */
Â  Â  Â  Â  }
Â  Â  Â  Â  .border-tamagotchi-accent-pink { border-color: #FF9AA2; /* Pink accent border */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* General rounding */
Â  Â  Â  Â  .rounded-tamagotchi-lg { border-radius: 20px; } /* More pronounced rounding for cards/buttons */
Â  Â  Â  Â  .rounded-tamagotchi-md { border-radius: 14px; } /* Medium rounding */
Â  Â  Â  Â  .rounded-tamagotchi-full { border-radius: 9999px; } /* Full rounding for circular elements */

Â  Â  Â  Â  /* Shadows (softer, toy-like) */
Â  Â  Â  Â  .shadow-tamagotchi { box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.1); } /* More pronounced, softer shadow */
Â  Â  Â  Â Â 
Â  Â  Â  Â  .nav-icon span {
Â  Â  Â  Â  Â  Â  font-size: 32px; /* Large emoji */
Â  Â  Â  Â  Â  Â  color: #A0A0A0; /* Soft gray for inactive icons */
Â  Â  Â  Â  Â  Â  transition: color 0.2s ease-in-out, transform 0.2s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-icon.active span {
Â  Â  Â  Â  Â  Â  color: #E75480; /* Stronger pink for active icon */
Â  Â  Â  Â  Â  Â  transform: scale(1.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Style for the 3D canvas */
Â  Â  Â  Â  #cookie-canvas {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  max-width: 400px; /* Keep max width to prevent distortion on very wide screens */
Â  Â  Â  Â  Â  Â  max-height: 400px; /* Keep max height */
Â  Â  Â  Â  Â  Â  cursor: grab;
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  position: relative; /* Ensure canvas is positioned above static */
Â  Â  Â  Â  Â  Â  z-index: 20; /* Higher than static */
Â  Â  Â  Â  Â  Â  margin: auto; /* Center the canvas */
Â  Â  Â  Â  }
Â  Â  Â  Â  #cookie-canvas:active {
Â  Â  Â  Â  Â  Â  cursor: grabbing;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Glaze color button styling */
Â  Â  Â  Â  #glaze-color-button {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 10px;
Â  Â  Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  Â  Â  z-index: 30; /* Ensure it's above other elements in the container */
Â  Â  Â  Â  Â  Â  width: 40px; /* Make it a square */
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  Â  Â  border-radius: 50%; /* Circular button */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  border: 2px solid #E0E0E0; /* Subtle border */
Â  Â  Â  Â  Â  Â  background-color: #f0f0f0; /* Default light background */
Â  Â  Â  Â  Â  Â  box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  transition: transform 0.1s ease-in-out, background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #glaze-color-button:active {
Â  Â  Â  Â  Â  Â  transform: translateY(1px);
Â  Â  Â  Â  Â  Â  box-shadow: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  /* GLITCHY STATIC TV EFFECT (Pale Butter Yellow Background)Â  Â  Â  */
Â  Â  Â  Â  /* =============================================================== */

Â  Â  Â  Â  .glitch-static {
Â  Â  Â  Â  Â  Â  position: relative; /* Needed for pseudo-elements */
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  background-color: #FFFACD !important; /* Pale Butter Yellow background - Added !important to override */
Â  Â  Â  Â  }

Â  Â  Â  Â  .glitch-static::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background:Â 
Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(rgba(240, 230, 200, 0.4) 1px, transparent 1px), /* Softer static lines, matching yellow */
Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(90deg, rgba(240, 230, 200, 0.4) 1px, transparent 1px);
Â  Â  Â  Â  Â  Â  background-size: 4px 4px; /* Slightly larger static pixels */
Â  Â  Â  Â  Â  Â  animation: static-flicker 0.5s infinite alternate, static-move 3s steps(10) infinite; /* Slower animations */
Â  Â  Â  Â  Â  Â  opacity: 0.6; /* Softer static */
Â  Â  Â  Â  Â  Â  pointer-events: none; /* Allows clicks/interactions with elements behind it */
Â  Â  Â  Â  Â  Â  z-index: 15; /* Below donut, above container bg */
Â  Â  Â  Â  }

Â  Â  Â  Â  .glitch-static::after {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background: linear-gradient(
Â  Â  Â  Â  Â  Â  Â  Â  to bottom,
Â  Â  Â  Â  Â  Â  Â  Â  transparent 0%,
Â  Â  Â  Â  Â  Â  Â  Â  rgba(240, 230, 200, 0.2) 50%, /* Softer yellow scanline */
Â  Â  Â  Â  Â  Â  Â  Â  transparent 100%
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  mix-blend-mode: overlay; /* Creates light distortion effect */
Â  Â  Â  Â  Â  Â  animation: scanline 8s linear infinite; /* Slower scanline */
Â  Â  Â  Â  Â  Â  opacity: 0.3; /* Slightly more pronounced scanline */
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  z-index: 16; /* Slightly above main static */
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes static-flicker {
Â  Â  Â  Â  Â  Â  0% { background-position: 0 0; opacity: 0.6; }
Â  Â  Â  Â  Â  Â  50% { background-position: 8px 8px; opacity: 0.5; } /* Larger displacement for flicker */
Â  Â  Â  Â  Â  Â  100% { background-position: 0 0; opacity: 0.7; }
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes static-move {
Â  Â  Â  Â  Â  Â  0% { transform: translate(0, 0); }
Â  Â  Â  Â  Â  Â  100% { transform: translate(0, 100%); }
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes scanline {
Â  Â  Â  Â  Â  Â  0% { background-position: 0 0; }
Â  Â  Â  Â  Â  Â  100% { background-position: 0 100%; }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  /* FALLING SNOW (GREY PIXELS) EFFECTÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  .falling-snow {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  z-index: 17; /* Above static, below donut */
Â  Â  Â  Â  Â  Â  overflow: hidden; /* Ensures snowflakes don't go outside */
Â  Â  Â  Â  }

Â  Â  Â  Â  .falling-snow::before,
Â  Â  Â  Â  .falling-snow::after {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  background-image:Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* Create many small grey "pixels" */
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 10% 20%, #A0A0A0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 70% 80%, #C0C0C0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 30% 60%, #B0B0B0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 90% 10%, #E0E0E0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 50% 40%, #D0D0D0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 20% 90%, #F0F0F0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 80% 30%, #A0A0A0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 40% 70%, #C0C0C0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 60% 5%, #B0B0B0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 5% 50%, #E0E0E0 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  radial-gradient(circle at 95% 45%, #D0D0D0 1px, transparent 1px);
Â  Â  Â  Â  Â  Â  background-repeat: repeat;
Â  Â  Â  Â  Â  Â  background-size: 20px 20px; /* Control the density */
Â  Â  Â  Â  Â  Â  animation: snowfall 10s linear infinite; /* Slower fall */
Â  Â  Â  Â  Â  Â  opacity: 0.7; /* Make them subtle */
Â  Â  Â  Â  }

Â  Â  Â  Â  .falling-snow::after {
Â  Â  Â  Â  Â  Â  animation-delay: 5s; /* Stagger the animation for more continuous effect */
Â  Â  Â  Â  Â  Â  background-size: 25px 25px; /* Different size for variety */
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  filter: blur(0.5px); /* Slight blur for depth */
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes snowfall {
Â  Â  Â  Â  Â  Â  0% { transform: translateY(-100%); }
Â  Â  Â  Â  Â  Â  100% { transform: translateY(100%); }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  /* SCROLLING TICKERÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  .ticker-wrap {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  background-color: #333; /* Dark background */
Â  Â  Â  Â  Â  Â  padding: 4px 0; /* Vertical padding */
Â  Â  Â  Â  Â  Â  border-top: 2px solid #555;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #555;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Specific margins for top and bottom tickers */
Â  Â  Â  Â  #top-ticker { margin-bottom: 8px; }
Â  Â  Â  Â  #bottom-ticker { margin-top: 8px; }


Â  Â  Â  Â  .ticker-move {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  animation: scroll-ticker 20s linear infinite; /* Adjust duration for speed */
Â  Â  Â  Â  Â  Â  color: #FFFACD; /* Pale Butter Yellow text */
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-family: 'Comic Neue', cursive; /* Match other text */
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  .ticker-move-reverse {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  animation: scroll-ticker-reverse 20s linear infinite; /* Adjust duration for speed */
Â  Â  Â  Â  Â  Â  color: #FFFACD; /* Pale Butter Yellow text */
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  font-family: 'Comic Neue', cursive; /* Match other text */
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes scroll-ticker {
Â  Â  Â  Â  Â  Â  0% { transform: translateX(0%); } /* Start visible */
Â  Â  Â  Â  Â  Â  100% { transform: translateX(-50%); } /* Move halfway, showing the duplicated text */
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes scroll-ticker-reverse {
Â  Â  Â  Â  Â  Â  0% { transform: translateX(-50%); } /* Start halfway */
Â  Â  Â  Â  Â  Â  100% { transform: translateX(0%); } /* Move back to start */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* =============================================================== */
Â  Â  Â  Â  /* DARK MODE STYLINGÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  /* =============================================================== */

Â  Â  Â  Â  /* Chocolate brown background */
Â  Â  Â  Â  body.dark { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background-color: #5C3317; /* Chocolate Brown */
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%236B4A34' fill-opacity='0.4'%3E%3Cpath d='M10 0L0 10l10 10 10-10z'/%3E%3Cpath d='M0 10L10 20l10-10L10 0z'/%3E%3C/g%3E%3C/svg%3E"),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(135deg, #5C3317 0%, #3D2B1F 100%);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Dark cards */
Â  Â  Â  Â  body.dark .bg-tamagotchi-card { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background-color: #3D2B1F; /* Dark, rich brown */
Â  Â  Â  Â  Â  Â  border-color: #4A3A2A; /* Darker border */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Light text for dark backgrounds */
Â  Â  Â  Â  body.dark .text-tamagotchi-dark { color: #F5E6C1; } /* Creamy white text */
Â  Â  Â  Â  body.dark .text-gray-500 { color: #A8998A; } /* Lighter, desaturated brown text */
Â  Â  Â  Â  body.dark .text-gray-600 { color: #B8A99A; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Pinks can stay, they pop nicely on brown */
Â  Â  Â  Â  body.dark .text-tamagotchi-pink-dark { color: #FF9AA2; } /* Lighten the pink a bit */

Â  Â  Â  Â  /* Glitch background */
Â  Â  Â  Â  body.dark .glitch-static { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background-color: #3D2B1F !important; /* Dark brown */
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark .glitch-static::before { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background:Â 
Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(rgba(150, 130, 110, 0.4) 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(90deg, rgba(150, 130, 110, 0.4) 1px, transparent 1px);
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark .glitch-static::after { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background: linear-gradient(
Â  Â  Â  Â  Â  Â  Â  Â  to bottom,
Â  Â  Â  Â  Â  Â  Â  Â  transparent 0%,
Â  Â  Â  Â  Â  Â  Â  Â  rgba(150, 130, 110, 0.2) 50%,
Â  Â  Â  Â  Â  Â  Â  Â  transparent 100%
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Falling snow (grey pixels) will look good on dark */
Â  Â  Â  Â  body.dark .falling-snow::before { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  opacity: 0.4;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark .falling-snow::after { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  opacity: 0.3;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Subtle borders */
Â  Â  Â  Â  body.dark .border-tamagotchi-subtle { border-color: #4A3A2A; } /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Light-on-dark for nav */
Â  Â  Â  Â  body.dark .nav-icon span { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  color: #A8998A; /* Lighter inactive icon */
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark .nav-icon.active span { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  color: #FF9AA2; /* Lighter active pink */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Color cycle button */
Â  Â  Â  Â  body.dark #glaze-color-button { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background-color: #3D2B1F;
Â  Â  Â  Â  Â  Â  border-color: #4A3A2A;
Â  Â  Â  Â  Â  Â  color: #F5E6C1; /* Light text */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* App background for sticky footer */
Â  Â  Â  Â  body.dark .bg-tamagotchi-bg-light { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background-color: #3D2B1F; /* Dark brown */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* NEW: Zoom Slider Styling */
Â  Â  Â  Â  .zoom-slider {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  right: 12px;
Â  Â  Â  Â  Â  Â  transform: translateY(-50%); /* Center vertically */
Â  Â  Â  Â  Â  Â  width: 20px; /* Track thickness */
Â  Â  Â  Â  Â  Â  height: 120px; /* Track length */
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  writing-mode: vertical-lr; /* Make it vertical */
Â  Â  Â  Â  Â  Â  direction: ltr;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  z-index: 30;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Dark mode style for slider */
Â  Â  Â  Â  body.dark .zoom-slider { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Thumb styling */
Â  Â  Â  Â  .zoom-slider::-webkit-slider-thumb {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  width: 26px; /* Touch target */
Â  Â  Â  Â  Â  Â  height: 26px;
Â  Â  Â  Â  Â  Â  background: #FFFACD; /* Pale Butter Yellow */
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  border: 2px solid #E75480; /* Pink border */
Â  Â  Â  Â  Â  Â  cursor: grab;
Â  Â  Â  Â  }
Â  Â  Â  Â  .zoom-slider::-moz-range-thumb {
Â  Â  Â  Â  Â  Â  width: 26px;
Â  Â  Â  Â  Â  Â  height: 26px;
Â  Â  Â  Â  Â  Â  background: #FFFACD;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  border: 2px solid #E75480;
Â  Â  Â  Â  Â  Â  cursor: grab;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Dark mode thumb */
Â  Â  Â  Â  body.dark .zoom-slider::-webkit-slider-thumb { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background: #3D2B1F; /* Dark brown */
Â  Â  Â  Â  Â  Â  border-color: #FF9AA2; /* Lighter pink */
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark .zoom-slider::-moz-range-thumb { /* Changed from #app-shell.dark to body.dark */
Â  Â  Â  Â  Â  Â  background: #3D2B1F;
Â  Â  Â  Â  Â  Â  border-color: #FF9AA2;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* END NEW STYLES */

Â  Â  </style>
</head>
<body class="text-tamagotchi-dark">
Â  Â  Â  Â Â 
Â  Â  <main class="flex-grow flex flex-col px-3 pt-4 pb-1 overflow-y-auto max-w-lg mx-auto w-full"> <div class="flex justify-between items-center mb-2">
Â  Â  Â  Â  Â  Â  <div class="flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-black text-tamagotchi-pink-dark" style="font-family: 'Luckiest Guy', cursive;">Donut Miner</h1>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="dark-mode-toggle-button" class="bg-tamagotchi-button-teal text-white text-lg w-10 h-10 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸŒ™
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="music-toggle-button" class="bg-tamagotchi-button-pink text-white text-lg w-10 h-10 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”‡
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="sfx-toggle-button" class="bg-tamagotchi-button-teal text-white text-lg w-10 h-10 flex items-center justify-center rounded-tamagotchi-md shadow-tamagotchi active:opacity-80">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”Š
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="view-glazery" class="flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-black text-tamagotchi-pink-dark mb-1">Glazery</h2>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-2" style="font-family: 'Comic Neue', cursive;">
Â  Â  Â  Â  Â  Â  Â  Â  Pay the Glaze Price to become KING GLAZER and earn 100% of $DONUT emissions until someone takes the spot after you.
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-2 grid grid-cols-3 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">Glazer</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="bakery-king-status" class="font-extrabold text-sm truncate text-tamagotchi-dark">None</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">Donuts/s</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-extrabold text-sm text-tamagotchi-dark">ğŸ© <span id="bakery-cps">0.00</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">Glaze Time</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-extrabold text-sm text-tamagotchi-dark"><span id="bakery-baked">00:00:00</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-2 grid grid-cols-3 gap-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">Donut Balance</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="player-donut-balance" class="font-extrabold text-sm truncate text-tamagotchi-dark">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">Total Glaze Time</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="player-total-glaze-time" class="font-extrabold text-sm text-tamagotchi-dark">00:00:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 font-semibold">% Mined</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-extrabold text-sm text-tamagotchi-dark"><span id="player-percent-mined">0.00</span>%</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="top-ticker" class="ticker-wrap" style="margin-bottom: 4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticker-move">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... </span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="cookie-rain-container" class="relative h-64 flex items-center justify-center overflow-hidden bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi glitch-static">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="falling-snow"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="cookie-canvas"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="glaze-color-button" class="shadow-tamagotchi bg-white text-tamagotchi-dark">ğŸ¨</button>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="glazery-zoom-slider" type="range" class="zoom-slider">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="bottom-ticker" class="ticker-wrap" style="margin-top: 4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticker-move-reverse">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour. ... </span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="bg-tamagotchi-card text-tamagotchi-dark p-2 rounded-tamagotchi-lg shadow-tamagotchi">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs font-semibold text-gray-600">Glaze Price</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xl font-extrabold text-tamagotchi-dark">$23.23</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500">$400.00 available</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="bakery-action-button" class="bg-tamagotchi-button-pink text-white py-2 px-6 rounded-tamagotchi-md text-sm font-bold active:opacity-80 disabled:opacity-50 shadow-tamagotchi">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Glaze
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="view-about" class="hidden flex-grow flex flex-col space-y-3">

Â  Â  Â  Â  Â  Â  <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-4 space-y-4 text-tamagotchi-dark">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg" style="font-family: 'Comic Neue', cursive;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Hello and welcome to Donut Miner!
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Pay the Glaze Price to become <strong>King Glazer</strong> and earn <strong>100%</strong> of the $DONUT emissions until you are replaced.
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Glaze price doubles each time a new Glazer takes over, and price cools down to $0 over 1 hour.
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-tamagotchi-pink-dark pt-2">Global Donut Stats</h3>
Â  Â  Â  Â  Â  Â  <div class="bg-tamagotchi-card rounded-tamagotchi-lg shadow-tamagotchi p-4 space-y-3 text-tamagotchi-dark">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600">Total Donut Supply</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="about-total-supply" class="font-extrabold text-tamagotchi-dark">ğŸ© 0</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600">Total % Mined</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="about-percent-mined" class="font-extrabold text-tamagotchi-dark">0.00%</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600">Time Until Halving</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="about-next-halving" class="font-extrabold text-tamagotchi-dark">--:--:--</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600">Total Miners</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="about-total-miners" class="font-extrabold text-tamagotchi-dark">ğŸ‘¤ 0</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  </main>

Â  Â  <nav class="grid grid-cols-2 gap-2 p-1 border-t border-tamagotchi-subtle bg-tamagotchi-card shadow-lg max-w-lg mx-auto w-full"> <button id="nav-glazery" class="nav-icon active flex flex-col items-center justify-center p-2 rounded-tamagotchi-md">
Â  Â  Â  Â  Â  Â  <span>ğŸ©</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="nav-about" class="nav-icon flex flex-col items-center justify-center p-2 rounded-tamagotchi-md">
Â  Â  Â  Â  Â  Â  <span>â„¹ï¸</span>
Â  Â  Â  Â  </button>
Â  Â  </nav>

<script>
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // CONFIGURATION
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  // !!! IMPORTANT: REPLACE 'https://last-game-kappa.vercel.app' WITH YOUR ACTUAL APP DOMAIN !!!
Â  Â  Â  Â  Â  Â  const PUBLIC_URL = 'https://last-game-kappa.vercel.app'; 
Â  Â  Â  Â  Â  Â  const GLAZE_FRAME_URL = `${PUBLIC_URL}/api/payment-frame`; 
Â  Â  Â  Â  Â  Â  // The transaction will be redirected to the payment frame endpoint, which handles the transaction,
Â  Â  Â  Â  Â  Â  // then redirects back to this game URL on success.

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // GAME STATE
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const state = {
Â  Â  Â  Â  Â  Â  Â  Â  // Player State
Â  Â  Â  Â  Â  Â  Â  Â  player: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cookies: 1000000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isBakerKing: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  claimableBakeryCookies: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalBakedCookies: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazeStartTime: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalGlazeTimeMs: 0, // NEW: Track total time
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  // Global Game State
Â  Â  Â  Â  Â  Â  Â  Â  global: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  emissionRate: 10,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCookiesCreated: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextHalvingAt: 1000000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalDonutSupply: 1000000000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalMiners: 1234,
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  // UI State
Â  Â  Â  Â  Â  Â  Â  Â  ui: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeView: 'glazery',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDarkMode: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSfxMuted: false
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // DOM ELEMENTS
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  const dom = {
Â  Â  Â  Â  Â  Â  Â  Â  views: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazery: document.getElementById('view-glazery'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  about: document.getElementById('view-about'),
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  aboutPage: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalSupply: document.getElementById('about-total-supply'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  percentMined: document.getElementById('about-percent-mined'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextHalving: document.getElementById('about-next-halving'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalMiners: document.getElementById('about-total-miners'),
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  nav: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazery: document.getElementById('nav-glazery'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  about: document.getElementById('nav-about'),
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  glazery: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  kingStatus: document.getElementById('bakery-king-status'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cps: document.getElementById('bakery-cps'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  baked: document.getElementById('bakery-baked'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton: document.getElementById('bakery-action-button'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas: document.getElementById('cookie-canvas'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rainContainer: document.getElementById('cookie-rain-container'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazeColorButton: document.getElementById('glaze-color-button'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  zoomSlider: document.getElementById('glazery-zoom-slider'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Second row stats
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutBalance: document.getElementById('player-donut-balance'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalGlazeTime: document.getElementById('player-total-glaze-time'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  percentMined: document.getElementById('player-percent-mined'),
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  musicToggleButton: document.getElementById('music-toggle-button'),
Â  Â  Â  Â  Â  Â  Â  Â  sfxToggleButton: document.getElementById('sfx-toggle-button'),
Â  Â  Â  Â  Â  Â  Â  Â  darkModeToggleButton: document.getElementById('dark-mode-toggle-button')
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // HELPER FUNCTIONS
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  const format = (num) => Math.floor(num).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
Â  Â  Â  Â  Â  Â  const formatDecimal = (num) => num.toFixed(2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const formatGlazeTime = (ms) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (ms === null || ms < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '00:00:00';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor(totalSeconds / 3600);
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return [hours, minutes, seconds]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(v => v.toString().padStart(2, '0'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .join(':');
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // AUDIO SETUP (Tone.js)
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  let kick, hiHat, bass, melody;
Â  Â  Â  Â  Â  Â  let kickSequence, hiHatSequence, bassSequence, melodySequence;
Â  Â  Â  Â  Â  Â  let isMusicPlaying = false;
Â  Â  Â  Â  Â  Â  let isAudioInitialized = false;

Â  Â  Â  Â  Â  Â  let purchaseSound, cuteClickSound;

Â  Â  Â  Â  Â  Â  function initAudio() {
Â  Â  Â  Â  Â  Â  Â  Â  if (isAudioInitialized) return;

Â  Â  Â  Â  Â  Â  Â  Â  Tone.Transport.bpm.value = 140;
Â  Â  Â  Â  Â  Â  Â  Â  Tone.Transport.swing = 0.2;
Â  Â  Â  Â  Â  Â  Â  Â  Tone.Transport.swingSubdivision = '8n';
Â  Â  Â  Â  Â  Â  Â  Â  const limiter = new Tone.Limiter(-6).toDestination();

Â  Â  Â  Â  Â  Â  Â  Â  // 1. KICK DRUM
Â  Â  Â  Â  Â  Â  Â  Â  kick = new Tone.MembraneSynth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pitchDecay: 0.01,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  octaves: 6,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oscillator: { type: 'sine' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 0.2 }
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const kickPattern = ['C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null, 'C2', null, null, null];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  kickSequence = new Tone.Sequence((time, note) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (note) kick.triggerAttackRelease(note, '8n', time);
Â  Â  Â  Â  Â  Â  Â  Â  }, kickPattern, '8n');
Â  Â  Â  Â  Â  Â  Â  Â  kickSequence.loop = true;

Â  Â  Â  Â  Â  Â  Â  Â  // 2. HI-HAT
Â  Â  Â  Â  Â  Â  Â  Â  hiHat = new Tone.NoiseSynth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noise: { type: 'white' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 }
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);

Â  Â  Â  Â  Â  Â  Â  Â  const hiHatPattern = [null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'G5', null, null, null, 'GC5', null];

Â  Â  Â  Â  Â  Â  Â  Â  hiHatSequence = new Tone.Sequence((time, note) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (note) hiHat.triggerAttackRelease('8n', time);
Â  Â  Â  Â  Â  Â  Â  Â  }, hiHatPattern, '8n');
Â  Â  Â  Â  Â  Â  Â  Â  hiHatSequence.loop = true;

Â  Â  Â  Â  Â  Â  Â  Â  // 3. BASS LINE
Â  Â  Â  Â  Â  Â  Â  Â  bass = new Tone.MonoSynth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oscillator: { type: 'sawtooth' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filter: { Q: 2, type: 'lowpass', cutoff: 400 },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);

Â  Â  Â  Â  Â  Â  Â  Â  const bassPattern = ['C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'C2', null, 'G2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'G#1', null, 'D#2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'F1', null, 'C2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', null, 'G1', null, 'D2', 'D2'];

Â  Â  Â  Â  Â  Â  Â  Â  bassSequence = new Tone.Sequence((time, note) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (note) bass.triggerAttackRelease(note, '8n', time);
Â  Â  Â  Â  Â  Â  Â  Â  }, bassPattern, '8n');
Â  Â  Â  Â  Â  Â  Â  Â  bassSequence.loop = true;

Â  Â  Â  Â  Â  Â  Â  Â  // 4. MELODY
Â  Â  Â  Â  Â  Â  Â  Â  melody = new Tone.FMSynth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  harmonicity: 3,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modulationIndex: 10,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oscillator: { type: 'sine' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);

Â  Â  Â  Â  Â  Â  Â  Â  const melodyPattern = ['G4', 'A#4', 'C5', null, 'G4', 'D#4', null, null, 'G4', 'A#4', 'C5', null, 'D#5', 'C5', 'A#4', null, 'G4', 'A#4', 'C5', null, 'G4', 'D#4', null, null, 'G4', 'A#4', 'G4', 'D#4', 'C4', null, null, null, 'G#4', 'C5', 'D#5', null, 'C5', 'G#4', null, null, 'G#4', 'C5', 'D#5', null, 'F5', 'D#5', 'C5', null, 'G#4', 'C5', 'D#5', null, 'C5', 'G#4', null, null, 'C5', 'A#4', 'G#4', 'F4', 'D#4', null, null, null, 'F4', 'G#4', 'C5', null, 'G#4', 'F4', null, null, 'F4', 'G#4', 'C5', null, 'D#5', 'C5', 'G#4', null, 'F4', 'G#4', 'C5', null, 'G#4', 'F4', null, null, 'F4', 'G#4', 'F4', 'D#4', 'C4', null, null, null, 'G4', 'B4', 'D5', null, 'D5', 'B4', 'G4', null, 'G4', 'B4', 'D5', 'F5', 'D5', 'B4', 'G4', null, 'A#4', null, 'B4', null, 'C5', null, 'B4', 'A#4', 'G4', 'F4', 'D#4', 'D4', 'C4', null, null, null];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  melodySequence = new Tone.Sequence((time, note) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (note) melody.triggerAttackRelease(note, '8n', time);
Â  Â  Â  Â  Â  Â  Â  Â  }, melodyPattern, '8n');
Â  Â  Â  Â  Â  Â  Â  Â  melodySequence.loop = true;

Â  Â  Â  Â  Â  Â  Â  Â  // Initialize SFX
Â  Â  Â  Â  Â  Â  Â  Â  cuteClickSound = new Tone.FMSynth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oscillator: { type: 'sine' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.1 },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  harmonicity: 0.5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modulationIndex: 2
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  purchaseSound = new Tone.Synth({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  oscillator: { type: 'triangle' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
Â  Â  Â  Â  Â  Â  Â  Â  }).connect(limiter);

Â  Â  Â  Â  Â  Â  Â  Â  isAudioInitialized = true;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function playSoundEffect(sound, ...args) {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.ui.isSfxMuted) return;

Â  Â  Â  Â  Â  Â  Â  Â  if (Tone.context.state !== 'running') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tone.start();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!isAudioInitialized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initAudio();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!state.ui.isSfxMuted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sound === 'crunch') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cuteClickSound.triggerAttackRelease('C6', '32n', Tone.now());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sound === 'purchase') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purchaseSound.triggerAttackRelease('C5', '16n', Tone.now());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purchaseSound.triggerAttackRelease('E5', '16n', Tone.now() + 0.05);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  purchaseSound.triggerAttackRelease('G5', '16n', Tone.now() + 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function toggleSfx() {
Â  Â  Â  Â  Â  Â  Â  Â  state.ui.isSfxMuted = !state.ui.isSfxMuted;
Â  Â  Â  Â  Â  Â  Â  Â  dom.sfxToggleButton.textContent = state.ui.isSfxMuted ? 'ğŸ”‡' : 'ğŸ”Š';

Â  Â  Â  Â  Â  Â  Â  Â  if (!state.ui.isSfxMuted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSoundEffect('crunch');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function toggleMusic() {
Â  Â  Â  Â  Â  Â  Â  Â  if (Tone.context.state !== 'running') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tone.start();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!isAudioInitialized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initAudio();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (isMusicPlaying) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Only stop the Transport. This stops all events
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // and resets the Transport time to 0.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tone.Transport.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  /* REMOVED: Explicitly stopping sequences caused errorsÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â and issues restarting.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (kickSequence) kickSequence.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (hiHatSequence) hiHatSequence.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bassSequence) bassSequence.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (melodySequence) melodySequence.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.musicToggleButton.textContent = 'ğŸ”‡';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tone.Transport.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Check if sequences are 'stopped' before starting them.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // This ensures they start on the first play, and also
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // restart correctly after being stopped by the Transport.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (kickSequence && kickSequence.state === 'stopped') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â kickSequence.start(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (hiHatSequence && hiHatSequence.state === 'stopped') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â hiHatSequence.start(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bassSequence && bassSequence.state === 'stopped') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â bassSequence.start(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (melodySequence && melodySequence.state === 'stopped') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â melodySequence.start(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.musicToggleButton.textContent = 'ğŸµ';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  isMusicPlaying = !isMusicPlaying;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // DARK MODE TOGGLE (NEW)
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  Â  Â  state.ui.isDarkMode = !state.ui.isDarkMode;
Â  Â  Â  Â  Â  Â  Â  Â  const body = document.body; // Changed from appShell to body
Â  Â  Â  Â  Â  Â  Â  Â  if (state.ui.isDarkMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body.classList.add('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.darkModeToggleButton.textContent = 'â˜€ï¸';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body.classList.remove('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.darkModeToggleButton.textContent = 'ğŸŒ™';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // 3D GLAZERY SETUP
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  let scene, camera, renderer, donutGroup, glazeMaterial;
Â  Â  Â  Â  Â  Â  let isDragging = false;
Â  Â  Â  Â  Â  Â  let previousPointerX = 0;
Â  Â  Â  Â  Â  Â  let previousPointerY = 0;
Â  Â  Â  Â  Â  Â  let initialPinchDistance = 0;
Â  Â  Â  Â  Â  Â  let currentCameraZ = 10;
Â  Â  Â  Â  Â  Â  let isThreeJSInitialized = false;Â 
Â  Â  Â  Â  Â  Â  let donutSpinSpeed = 0.005; // NEW: Control variable for spin speed

Â  Â  Â  Â  Â  Â  const MIN_ZOOM_Z = 3;
Â  Â  Â  Â  Â  Â  const MAX_ZOOM_Z = 20;

Â  Â  Â  Â  Â  Â  const glazeColors = [
Â  Â  Â  Â  Â  Â  Â  Â  0xFFC0CB, // Original Pink
Â  Â  Â  Â  Â  Â  Â  Â  0xADD8E6, // Light Blue
Â  Â  Â  Â  Â  Â  Â  Â  0x90EE90, // Light Green
Â  Â  Â  Â  Â  Â  Â  Â  0xFFD700, // Gold (Yellow)
Â  Â  Â  Â  Â  Â  Â  Â  0x800080, // Purple
Â  Â  Â  Â  Â  Â  Â  Â  0xFFF8DC, // Cream
Â  Â  Â  Â  Â  Â  Â  Â  0xFF0000, // Red
Â  Â  Â  Â  Â  Â  Â  Â  0x000000Â  // Black
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  let currentGlazeColorIndex = 0;

Â  Â  Â  Â  Â  Â  function createCrackTexture(size = 1024) {
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = size;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = size;
Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'white';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, size, size);

Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#333333';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineCap = 'round';
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineJoin = 'round';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < 15; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let startX = Math.random() * size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let startY = Math.random() * size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(startX, startY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let len = Math.random() * 60 + 30;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentX = startX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentY = startY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let j = 0; j < 5; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentX += (Math.random() - 0.5) * len;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentY += (Math.random() - 0.5) * len;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentX = Math.max(0, Math.min(size, currentX));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â currentY = Math.max(0, Math.min(size, currentY));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(currentX, currentY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  len *= 0.8;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return new THREE.CanvasTexture(canvas);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function createSpeckleTexture(size = 512, color = 'rgba(0,0,0,0.5)') {
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = size;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = size;
Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#FFFFFF';Â 
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, size, size);

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < 2000; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const x = Math.random() * size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y = Math.random() * size;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = Math.random() * 0.8 + 0.4;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const alpha = Math.random() * 0.5 + 0.3;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shade = Math.floor(Math.random() * 40);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = `rgba(${shade}, ${shade}, ${shade}, ${alpha})`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(x, y, r, 0, Math.PI * 2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return new THREE.CanvasTexture(canvas);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function initThreeJS() {
Â  Â  Â  Â  Â  Â  Â  Â  if (isThreeJSInitialized) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  scene = new THREE.Scene();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const container = dom.glazery.rainContainer;
Â  Â  Â  Â  Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â  Â  Â  Â  Â  const w = container.clientWidth || 300;
Â  Â  Â  Â  Â  Â  Â  Â  const h = container.clientHeight || 300;

Â  Â  Â  Â  Â  Â  Â  Â  camera = new THREE.PerspectiveCamera(75, w / h, 0.1, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  camera.position.z = currentCameraZ;

Â  Â  Â  Â  Â  Â  Â  Â  if (!dom.glazery.canvas) return;
Â  Â  Â  Â  Â  Â  Â  Â  renderer = new THREE.WebGLRenderer({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas: dom.glazery.canvas,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alpha: true
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  renderer.setSize(w, h);
Â  Â  Â  Â  Â  Â  Â  Â  renderer.setPixelRatio(window.devicePixelRatio);

Â  Â  Â  Â  Â  Â  Â  Â  const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
Â  Â  Â  Â  Â  Â  Â  Â  scene.add(ambientLight);
Â  Â  Â  Â  Â  Â  Â  Â  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);Â 
Â  Â  Â  Â  Â  Â  Â  Â  directionalLight.position.set(5, 5, 5);
Â  Â  Â  Â  Â  Â  Â  Â  scene.add(directionalLight);

Â  Â  Â  Â  Â  Â  Â  Â  donutGroup = new THREE.Group();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Donut Base
Â  Â  Â  Â  Â  Â  Â  Â  const donutGeometry = new THREE.TorusGeometry(2.8, 1.3, 32, 100);

Â  Â  Â  Â  Â  Â  Â  Â  const crackTexture = createCrackTexture(1024);
Â  Â  Â  Â  Â  Â  Â  Â  crackTexture.wrapS = crackTexture.wrapT = THREE.RepeatWrapping;
Â  Â  Â  Â  Â  Â  Â  Â  crackTexture.repeat.set(1, 1);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const speckleTexture = createSpeckleTexture(512);
Â  Â  Â  Â  Â  Â  Â  Â  speckleTexture.wrapS = speckleTexture.wrapT = THREE.RepeatWrapping;
Â  Â  Â  Â  Â  Â  Â  Â  speckleTexture.repeat.set(3, 3);

Â  Â  Â  Â  Â  Â  Â  Â  const donutMaterial = new THREE.MeshStandardMaterial({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 0x5C3317,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roughness: 0.8,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metalness: 0.05,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map: speckleTexture,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bumpMap: crackTexture,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bumpScale: 0.08
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const donutBase = new THREE.Mesh(donutGeometry, donutMaterial);
Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.add(donutBase);

Â  Â  Â  Â  Â  Â  Â  Â  // Glaze Layer
Â  Â  Â  Â  Â  Â  Â  Â  const glazeRadius = 2.75;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const glazeTubeRadius = 1.35;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const radialSegments = 32;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const tubularSegments = 100;

Â  Â  Â  Â  Â  Â  Â  Â  const glazeGeometry = new THREE.TorusGeometry(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazeRadius,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazeTubeRadius,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radialSegments,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tubularSegments
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const positionAttribute = glazeGeometry.attributes.position;
Â  Â  Â  Â  Â  Â  Â  Â  const tempVector = new THREE.Vector3();
Â  Â  Â  Â  Â  Â  Â  Â  const irregularityFactor = 0.15;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const randomOffsets = new Array(tubularSegments).fill(0).map(() => Math.random() * irregularityFactor * 2 - irregularityFactor);

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < positionAttribute.count; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempVector.fromBufferAttribute(positionAttribute, i);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const x = tempVector.x;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const y = tempVector.y;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const z = tempVector.z;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = Math.sqrt(x * x + y * y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const angleAroundDonut = Math.atan2(y, x);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const distFromGlazeMainRadius = Math.abs(r - glazeRadius);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isOuterEdge = distFromGlazeMainRadius < (glazeTubeRadius * 0.4) && r > glazeRadius;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isBottomHalf = z < -0.4 * glazeTubeRadius;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isInnerEdge = distFromGlazeMainRadius < (glazeTubeRadius * 0.4) && r < glazeRadius;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isOuterEdge && isBottomHalf) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const segmentIndex = Math.floor((angleAroundDonut / (2 * Math.PI)) * tubularSegments + tubularSegments) % tubularSegments;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const scallopMagnitude = 0.1 + (randomOffsets[segmentIndex] * 0.8 + 0.5) * 0.1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentRadius = Math.sqrt(tempVector.x * tempVector.x + tempVector.y * tempVector.y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const normalizedX = tempVector.x / currentRadius;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const normalizedY = tempVector.y / currentRadius;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempVector.x += normalizedX * scallopMagnitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempVector.y += normalizedY * scallopMagnitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempVector.z += scallopMagnitude * 0.5;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  positionAttribute.setXYZ(i, tempVector.x, tempVector.y, tempVector.z);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (isInnerEdge) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (tempVector.z < -0.1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tempVector.z = Math.min(tempVector.z + 0.1, 0);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  positionAttribute.setXYZ(i, tempVector.x, tempVector.y, tempVector.z);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  glazeGeometry.attributes.position.needsUpdate = true;
Â  Â  Â  Â  Â  Â  Â  Â  glazeGeometry.computeVertexNormals();Â 

Â  Â  Â  Â  Â  Â  Â  Â  glazeMaterial = new THREE.MeshStandardMaterial({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: glazeColors[currentGlazeColorIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roughness: 0.2,Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metalness: 0.1,Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transparent: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0.85Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const glaze = new THREE.Mesh(glazeGeometry, glazeMaterial);
Â  Â  Â  Â  Â  Â  Â  Â  glaze.position.z = 0.05;Â 
Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.add(glaze);

Â  Â  Â  Â  Â  Â  Â  Â  // Sprinkles
Â  Â  Â  Â  Â  Â  Â  Â  const sprinkleColors = [0xFF0000, 0xFF7F00, 0xFFFF00, 0x00FF00, 0x0000FF, 0x4B0082, 0x9400D3];
Â  Â  Â  Â  Â  Â  Â  Â  const sprinkleShape = new THREE.CylinderGeometry(0.06, 0.06, 0.4, 8);Â 
Â  Â  Â  Â  Â  Â  Â  Â  const numSprinkles = 800;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const R_sprinkle = 2.8;Â 
Â  Â  Â  Â  Â  Â  Â  Â  const r_sprinkle = 1.3 * 0.9;Â 

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < numSprinkles; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const color = sprinkleColors[Math.floor(Math.random() * sprinkleColors.length)];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sprinkleMaterial = new THREE.MeshStandardMaterial({ color: color });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sprinkle = new THREE.Mesh(sprinkleShape, sprinkleMaterial);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const u = Math.random() * 2 * Math.PI;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const v = Math.random() * 2 * Math.PI;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.position.x = (R_sprinkle + r_sprinkle * Math.cos(u)) * Math.cos(v);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.position.y = (R_sprinkle + r_sprinkle * Math.cos(u)) * Math.sin(v);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.position.z = r_sprinkle * Math.sin(u);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (sprinkle.position.z < -0.2 * 1.3) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const centerOfTubeCrossSection = new THREE.Vector3(R_sprinkle * Math.cos(v), R_sprinkle * Math.sin(v), 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const normal = new THREE.Vector3().subVectors(sprinkle.position, centerOfTubeCrossSection).normalize();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.position.addScaledVector(normal, 0.12);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.lookAt(new THREE.Vector3().addVectors(sprinkle.position, normal));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.rotateX(Math.PI / 2);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sprinkle.rotation.z += Math.random() * Math.PI;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.add(sprinkle);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  scene.add(donutGroup);

Â  Â  Â  Â  Â  Â  Â  Â  // Add pointer listeners for Glazery
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.addEventListener('pointerdown', onPointerDown);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.addEventListener('pointermove', onPointerMove);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.addEventListener('pointerup', onPointerUp);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.addEventListener('pointerleave', onPointerUp);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.addEventListener('wheel', onMouseWheel, { passive: false });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Setup zoom slider
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.min = MIN_ZOOM_Z;
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.max = MAX_ZOOM_Z;
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.value = currentCameraZ;
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.step = 0.1;

Â  Â  Â  Â  Â  Â  Â  Â  isThreeJSInitialized = true;Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // UNIVERSAL 3D CONTROLS & ANIMATION
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  function onResize() {
Â  Â  Â  Â  Â  Â  Â  Â  // Resize Glazery Canvas
Â  Â  Â  Â  Â  Â  Â  Â  if (renderer && camera && dom.glazery.rainContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const container = dom.glazery.rainContainer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const w = container.clientWidth;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const h = container.clientHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (w > 0 && h > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.aspect = w / h;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderer.setSize(w, h);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  window.addEventListener('resize', onResize);

Â  Â  Â  Â  Â  Â  function animate() {
Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(animate);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Render Glazery if active
Â  Â  Â  Â  Â  Â  Â  Â  if (state.ui.activeView === 'glazery' && donutGroup && renderer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // MODIFIED: Always spin based on donutSpinSpeed, remove isDragging check
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.rotation.y += donutSpinSpeed;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Add damping/friction to slow the spin down
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (donutSpinSpeed > 0.005) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutSpinSpeed *= 0.95; // Apply friction
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If it gets very close to the base speed, clamp it
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (donutSpinSpeed < 0.006) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutSpinSpeed = 0.005;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderer.render(scene, camera);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Glazery (Donut) Pointer Events ---
Â  Â  Â  Â  Â  Â  let pointers = [];

Â  Â  Â  Â  Â  Â  function getPinchDistance(e) {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.touches && e.touches.length === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dx = e.touches[0].clientX - e.touches[1].clientX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dy = e.touches[0].clientY - e.touches[1].clientY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return Math.sqrt(dx * dx + dy * dy);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function onPointerDown(e) {
Â  Â  Â  Â  Â  Â  Â  Â  pointers.push(e);
Â  Â  Â  Â  Â  Â  Â  Â  if (pointers.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDragging = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previousPointerX = e.clientX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previousPointerY = e.clientY;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (pointers.length === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initialPinchDistance = getPinchDistance(e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.setPointerCapture(e.pointerId);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function onPointerMove(e) {
Â  Â  Â  Â  Â  Â  Â  Â  const index = pointers.findIndex(p => p.pointerId === e.pointerId);
Â  Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointers[index] = e;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (pointers.length === 2 && initialPinchDistance > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentPinchDistance = getPinchDistance(e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentPinchDistance === 0) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const zoomFactor = initialPinchDistance / currentPinchDistance;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newZ = currentCameraZ * zoomFactor;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newZ = Math.max(MIN_ZOOM_Z, Math.min(MAX_ZOOM_Z, newZ));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.position.z = newZ;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.value = newZ;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initialPinchDistance = currentPinchDistance;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCameraZ = newZ;

Â  Â  Â  Â  Â  Â  Â  Â  } else if (isDragging && pointers.length === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deltaX = e.clientX - previousPointerX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deltaY = e.clientY - previousPointerY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.rotation.y += deltaX * 0.01;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  donutGroup.rotation.x += deltaY * 0.01;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previousPointerX = e.clientX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previousPointerY = e.clientY;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function onPointerUp(e) {
Â  Â  Â  Â  Â  Â  Â  Â  pointers = pointers.filter(p => p.pointerId !== e.pointerId);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.canvas.releasePointerCapture(e.pointerId);

Â  Â  Â  Â  Â  Â  Â  Â  if (isDragging && pointers.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deltaX = Math.abs(e.clientX - previousPointerX);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deltaY = Math.abs(e.clientY - previousPointerY);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(deltaX < 5 && deltaY < 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If this was a tap/click (not a drag), we do nothing now, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // as the primary action is on the explicit 'Glaze' button.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDragging = false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (pointers.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initialPinchDistance = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function onMouseWheel(e) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  let newZ = currentCameraZ + e.deltaY * 0.02;
Â  Â  Â  Â  Â  Â  Â  Â  newZ = Math.max(MIN_ZOOM_Z, Math.min(MAX_ZOOM_Z, newZ));
Â  Â  Â  Â  Â  Â  Â  Â  camera.position.z = newZ;
Â  Â  Â  Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.value = newZ;
Â  Â  Â  Â  Â  Â  Â  Â  currentCameraZ = newZ;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function changeGlazeColor() {
Â  Â  Â  Â  Â  Â  Â  Â  if (glazeMaterial) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentGlazeColorIndex = (currentGlazeColorIndex + 1) % glazeColors.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  glazeMaterial.color.set(glazeColors[currentGlazeColorIndex]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // RENDER/UPDATE FUNCTIONS
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  const updateUI = () => {
Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Calculate percentMined globally for both views
Â  Â  Â  Â  Â  Â  Â  Â  const { totalDonutSupply, totalCookiesCreated, nextHalvingAt, totalMiners } = state.global;
Â  Â  Â  Â  Â  Â  Â  Â  const percentMined = totalDonutSupply > 0 ? (totalCookiesCreated / totalDonutSupply) * 100 : 0;

Â  Â  Â  Â  Â  Â  Â  Â  // Update Glazery View (always, since it's the main view)
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // NEW: Update second row of stats
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.donutBalance.textContent = 'ğŸ© ' + format(state.player.cookies);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.totalGlazeTime.textContent = formatGlazeTime(state.player.totalGlazeTimeMs);
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.percentMined.textContent = formatDecimal(percentMined);

Â  Â  Â  Â  Â  Â  Â  Â  // --- Update first row of stats ---
Â  Â  Â  Â  Â  Â  Â  Â  const bakeryCps = state.player.isBakerKing ? state.global.emissionRate : 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.cps.textContent = formatDecimal(bakeryCps);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (state.player.isBakerKing && state.player.glazeStartTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const elapsedMs = Date.now() - state.player.glazeStartTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.baked.textContent = formatGlazeTime(elapsedMs);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.baked.textContent = '00:00:00';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const claimableBakery = Math.floor(state.player.claimableBakeryCookies);
Â  Â  Â  Â  Â  Â  Â  Â  if (state.player.isBakerKing) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.kingStatus.textContent = 'You';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.actionButton.textContent = `Bake ${format(claimableBakery)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.actionButton.disabled = claimableBakery < 1;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.kingStatus.textContent = 'None';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.actionButton.textContent = 'Glaze';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.glazery.actionButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Update About Page Stats
Â  Â  Â  Â  Â  Â  Â  Â  if (state.ui.activeView === 'about') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // const { totalDonutSupply, totalCookiesCreated, nextHalvingAt, totalMiners } = state.global; // MOVED UP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.aboutPage.totalSupply.textContent = `ğŸ© ${format(totalDonutSupply)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // const percentMined = totalDonutSupply > 0 ? (totalCookiesCreated / totalDonutSupply) * 100 : 0; // MOVED UP
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.aboutPage.percentMined.textContent = `${formatDecimal(percentMined)}%`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blocksRemaining = nextHalvingAt - totalCookiesCreated;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const secondsRemaining = Math.max(0, Math.floor(blocksRemaining * (GAME_TICK_MS / 100)));Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor(secondsRemaining / 3600);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((secondsRemaining % 3600) / 60);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const seconds = secondsRemaining % 60;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.aboutPage.nextHalving.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.aboutPage.totalMiners.textContent = `ğŸ‘¤ ${format(totalMiners)}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 

Â  Â  Â  Â  Â  Â  const showView = (viewName) => {
Â  Â  Â  Â  Â  Â  Â  Â  // Hide all views
Â  Â  Â  Â  Â  Â  Â  Â  for (const key in dom.views) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.views[key].classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Deactivate all nav icons
Â  Â  Â  Â  Â  Â  Â  Â  for (const key in dom.nav) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.nav[key].classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Show selected view
Â  Â  Â  Â  Â  Â  Â  Â  if (dom.views[viewName]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.views[viewName].classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.ui.activeView = viewName;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // Activate selected nav icon
Â  Â  Â  Â  Â  Â  Â  Â  if (dom.nav[viewName]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dom.nav[viewName].classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (viewName === 'glazery' && !isThreeJSInitialized) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(initThreeJS, 0);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(onResize, 50);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // GAME ACTIONS (MODIFIED)
Â  Â  Â  Â  Â  Â  // ===============================================================

Â  Â  Â  Â  Â  Â  const handleMinerAction = () => {
Â  Â  Â  Â  Â  Â  Â  Â  donutSpinSpeed = 0.5; // Set spin speed to high!

Â  Â  Â  Â  Â  Â  Â  Â  if (state.player.isBakerKing) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Action: Claim "Bake" (In-game logic)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const claimable = Math.floor(state.player.claimableBakeryCookies);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (claimable > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSoundEffect('purchase');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.player.cookies += claimable;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.player.totalBakedCookies += claimable;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.player.claimableBakeryCookies = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Claimed ${claimable} cookies.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Action: Become "Glazer" (King) - **TRIGGER FARCASTER FRAME**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Glaze button clicked. Redirecting to Farcaster Frame endpoint.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // This redirection causes the Farcaster client (e.g., Warpcast) to 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // pop up the transaction/payment frame defined by the target URL.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = GLAZE_FRAME_URL;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Exit the function to prevent further local updates
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // GAME LOOP
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const GAME_TICK_MS = 100;

Â  Â  Â  Â  Â  Â  const gameLoop = () => {
Â  Â  Â  Â  Â  Â  Â  Â  // MOCK: Increment total mined cookies for countdown demo
Â  Â  Â  Â  Â  Â  Â  Â  state.global.totalCookiesCreated += state.global.emissionRate * (GAME_TICK_MS / 1000);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // MOCK: Increment claimable cookies if king
Â  Â  Â  Â  Â  Â  Â  Â  if (state.player.isBakerKing) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bakeryCps = state.global.emissionRate;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.player.claimableBakeryCookies += bakeryCps * (GAME_TICK_MS / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.player.totalGlazeTimeMs += GAME_TICK_MS; // NEW: Increment total glaze time
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â  // INITIALIZATION
Â  Â  Â  Â  Â  Â  // ===============================================================
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  dom.nav.glazery.onclick = () => { playSoundEffect('crunch'); showView('glazery'); };
Â  Â  Â  Â  Â  Â  dom.nav.about.onclick = () => { playSoundEffect('crunch'); showView('about'); };

Â  Â  Â  Â  Â  Â  dom.glazery.actionButton.onclick = handleMinerAction;
Â  Â  Â  Â  Â  Â  dom.musicToggleButton.onclick = toggleMusic;
Â  Â  Â  Â  Â  Â  dom.sfxToggleButton.onclick = toggleSfx;
Â  Â  Â  Â  Â  Â  dom.darkModeToggleButton.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  playSoundEffect('crunch');
Â  Â  Â  Â  Â  Â  Â  Â  toggleDarkMode();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  dom.glazery.glazeColorButton.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  playSoundEffect('crunch');
Â  Â  Â  Â  Â  Â  Â  Â  changeGlazeColor();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  dom.glazery.zoomSlider.oninput = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isThreeJSInitialized) return;
Â  Â  Â  Â  Â  Â  Â  Â  const newZ = parseFloat(dom.glazery.zoomSlider.value);
Â  Â  Â  Â  Â  Â  Â  Â  camera.position.z = newZ;
Â  Â  Â  Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  currentCameraZ = newZ;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  showView('glazery');
Â  Â  Â  Â  Â  Â  setInterval(gameLoop, GAME_TICK_MS);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!isThreeJSInitialized) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(initThreeJS, 0);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  animate();
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
